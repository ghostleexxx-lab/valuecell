# Build frontend
FROM oven/bun:1 AS frontend-builder
WORKDIR /app
COPY frontend/package.json frontend/bun.lock ./
RUN bun install --frozen-lockfile
COPY frontend .
RUN bun run build

# Final stage
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

# Install uv.
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

WORKDIR /app

ENV UV_HTTP_TIMEOUT=500
ENV UV_INDEX_URL=https://mirrors.aliyun.com/pypi/simple/

# Pre-cache the application dependencies.
COPY python/pyproject.toml python/uv.lock ./
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-install-project --frozen

# Copy the application into the container.
COPY python /app

# Copy frontend build
COPY --from=frontend-builder /app/build/client /app/static

# Install the application dependencies.
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync

EXPOSE 8000

# Run the application.
CMD ["uv", "run", "python", "-m", "valuecell.server.main", "--host", "0.0.0.0", "--port", "8000"]
